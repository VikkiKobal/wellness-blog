---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import PageHero from '../../components/PageHero.astro';
import Footer from '../../components/Footer.astro';
import * as api from '../../utils/api';
import { marked } from 'marked';

// In SSR mode, we don't use getStaticPaths.
// Instead, we fetch the data on every request.
const { id } = Astro.params;

let article: api.Article | null = null;
let recentArticles: api.Article[] = [];

try {
  const articles = await api.getArticles();
  article = articles.find(a => a.id === id) || null;
  
  if (article) {
    recentArticles = articles
      .filter(a => a.id !== id)
      .slice(0, 3);
  }
} catch (error) {
  console.error('Error fetching article:', error);
}

if (!article) {
  return Astro.redirect('/404');
}

// Convert Markdown to HTML
const contentHtml = await marked(article.content);

const breadcrumb = [
  { label: 'Home', href: '/' },
  { label: 'Blog', href: '/blog' },
  { label: article.title, href: '#' }
];
---

<Layout title={`${article.title} | Antonina Devitska`} description={article.excerpt}>
  <Header currentPage="blog" />
  
  <main>
    <PageHero 
      title="Explore My Stories & Insights" 
      breadcrumb={breadcrumb}
    />
    
    <article class="article-page">
      <div class="container">
        <!-- Author Info Section -->
        <div class="author-section">
          <div class="author-avatar">
            <img src="/images/about-portrait.png" alt={article.author} />
          </div>
          <div class="author-info">
            <span class="author-name">{article.author || 'Antonina Devitska'}</span>
          </div>
          <div class="article-date">
            <svg width="26" height="26" viewBox="0 0 26 26" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M20.5833 4.33334H19.5V3.25001C19.5 2.96376 19.3862 2.68922 19.1835 2.48652C18.9808 2.28382 18.7062 2.17001 18.42 2.17001C18.1337 2.17001 17.8592 2.28382 17.6565 2.48652C17.4538 2.68922 17.34 2.96376 17.34 3.25001V4.33334H8.66V3.25001C8.66 2.96376 8.54619 2.68922 8.34349 2.48652C8.14079 2.28382 7.86625 2.17001 7.58 2.17001C7.29375 2.17001 7.01921 2.28382 6.81651 2.48652C6.61381 2.68922 6.5 2.96376 6.5 3.25001V4.33334H5.41667C4.55797 4.33334 3.73453 4.67455 3.12066 5.28842C2.50679 5.90229 2.16559 6.72572 2.16559 7.58441V21.6667C2.16559 22.5254 2.50679 23.3488 3.12066 23.9627C3.73453 24.5766 4.55797 24.9178 5.41667 24.9178H20.5833C21.442 24.9178 22.2655 24.5766 22.8793 23.9627C23.4932 23.3488 23.8344 22.5254 23.8344 21.6667V7.58441C23.8344 6.72572 23.4932 5.90229 22.8793 5.28842C22.2655 4.67455 21.442 4.33334 20.5833 4.33334ZM21.6667 21.6667C21.6667 21.953 21.5529 22.2275 21.3502 22.4302C21.1475 22.6329 20.8729 22.7467 20.5867 22.7467H5.41667C5.13042 22.7467 4.85588 22.6329 4.65318 22.4302C4.45048 22.2275 4.33667 21.953 4.33667 21.6667V10.8333H21.6667V21.6667ZM21.6667 8.66667H4.33667V7.58441C4.33667 7.29816 4.45048 7.02363 4.65318 6.82093C4.85588 6.61823 5.13042 6.50441 5.41667 6.50441H6.5V7.58441C6.5 7.87066 6.61381 8.1452 6.81651 8.3479C7.01921 8.5506 7.29375 8.66441 7.58 8.66441C7.86625 8.66441 8.14079 8.5506 8.34349 8.3479C8.54619 8.1452 8.66 7.87066 8.66 7.58441V6.50441H17.34V7.58441C17.34 7.87066 17.4538 8.1452 17.6565 8.3479C17.8592 8.5506 18.1337 8.66441 18.42 8.66441C18.7062 8.66441 18.9808 8.5506 19.1835 8.3479C19.3862 8.1452 19.5 7.87066 19.5 7.58441V6.50441H20.5833C20.8696 6.50441 21.1441 6.61823 21.3468 6.82093C21.5495 7.02363 21.6633 7.29816 21.6633 7.58441V8.66667H21.6667Z" fill="currentColor"/>
            </svg>
            <span>{article.date}</span>
          </div>
        </div>
        
        <!-- Featured Image -->
        <div class="featured-image">
          <img src={article.image || '/images/blog-1.png'} alt={article.title} />
        </div>
        
        <!-- Article Content -->
        <div class="article-content" set:html={contentHtml}></div>
        
        <!-- Divider -->
        <div class="divider"></div>
        
        <!-- Recent Articles Section -->
        {recentArticles.length > 0 && (
          <section class="recent-articles">
            <h2 class="section-title">Recent Articles</h2>
            <div class="recent-articles-grid">
              {recentArticles.map(recentArticle => (
                <div class="recent-card">
                  <a href={`/blog/${recentArticle.id}`}>
                    <img src={recentArticle.image || '/images/blog-1.png'} alt={recentArticle.title} />
                    <h3>{recentArticle.title}</h3>
                    <p>{recentArticle.excerpt}</p>
                  </a>
                </div>
              ))}
            </div>
          </section>
        )}
      </div>
    </article>
  </main>
  
  <Footer />
</Layout>

<style>
  .article-page {
    padding: 60px 0 100px;
  }
  
  .author-section {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 32px;
    flex-wrap: wrap;
  }
  
  .author-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
  }
  
  .author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .author-name {
    font-family: var(--font-secondary);
    font-weight: 500;
    font-size: 16px;
    color: #323232;
  }
  
  .article-date {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--font-secondary);
    font-weight: 400;
    font-size: 15px;
    color: #666;
    margin-left: auto;
  }

  @media (max-width: 600px) {
    .author-section {
      flex-direction: row;
      justify-content: flex-start;
    }
    .article-date {
      margin-left: 0;
      width: 100%;
      margin-top: -8px;
      padding-left: 64px; /* Align with name */
    }
  }
  
  .article-date svg {
    color: var(--color-primary);
  }
  
  .featured-image {
    width: 100%;
    max-width: 932px;
    margin: 0 auto 50px;
    border-radius: 5px;
    overflow: hidden;
  }
  
  .featured-image img {
    width: 100%;
    height: auto;
    object-fit: cover;
  }
  
  .article-content {
    max-width: 932px;
    margin: 0 auto;
  }
  
  .article-content :global(p) {
    font-family: var(--font-primary);
    font-weight: 400;
    font-size: 19px;
    line-height: 1.84;
    color: var(--color-text-black);
    margin-bottom: 28px;
  }
  
  .article-content :global(h2) {
    font-family: var(--font-primary);
    font-weight: 600;
    font-size: 28px;
    line-height: 1.4;
    color: var(--color-text-dark);
    margin: 40px 0 20px;
  }
  
  .article-content :global(h3) {
    font-family: var(--font-primary);
    font-weight: 600;
    font-size: 22px;
    line-height: 1.4;
    color: var(--color-text-dark);
    margin: 32px 0 16px;
  }
  
  .article-content :global(ul),
  .article-content :global(ol) {
    margin: 20px 0;
    padding-left: 24px;
  }
  
  .article-content :global(li) {
    font-family: var(--font-primary);
    font-weight: 400;
    font-size: 19px;
    line-height: 1.84;
    color: var(--color-text-black);
    margin-bottom: 12px;
  }
  
  .article-content :global(blockquote) {
    margin: 30px 0;
    padding: 20px 30px;
    border-left: 4px solid var(--color-primary);
    background: rgba(141, 119, 171, 0.05);
    font-style: italic;
  }
  
  .article-content :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
  }
  
  .article-content :global(a:hover) {
    color: var(--color-primary-dark);
  }
  
  .divider {
    max-width: 932px;
    margin: 60px auto;
    height: 1px;
    background: var(--color-gray);
  }
  
  .recent-articles {
    max-width: 932px;
    margin: 0 auto;
  }
  
  .section-title {
    font-family: var(--font-primary);
    font-weight: 600;
    font-size: 32px;
    line-height: 1.56;
    color: var(--color-text-black);
    text-align: center;
    margin-bottom: 40px;
  }
  
  .recent-articles-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
  }

  .recent-card a {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .recent-card img {
    width: 100%;
    aspect-ratio: 16/9;
    object-fit: cover;
    border-radius: 8px;
  }

  .recent-card h3 {
    font-size: 18px;
    font-weight: 600;
    color: var(--color-text-dark);
  }

  .recent-card p {
    font-size: 14px;
    color: var(--color-text-light);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  @media (max-width: 768px) {
    .article-page {
      padding: 40px 0 80px;
    }
    
    .author-section {
      gap: 16px;
    }
    
    .author-avatar {
      width: 50px;
      height: 50px;
    }
    
    .author-name,
    .article-date {
      font-size: 14px;
    }
    
    .article-date {
      margin-left: 0;
      width: 100%;
    }
    
    .article-content :global(p) {
      font-size: 16px;
    }
    
    .article-content :global(li) {
      font-size: 16px;
    }
    
    .section-title {
      font-size: 26px;
    }
    
    .recent-articles-grid {
      grid-template-columns: 1fr;
      gap: 32px;
    }
  }
</style>
