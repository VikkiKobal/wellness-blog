---
const testimonials = [
  {
    quote:
      '“Antonina guided our leadership team through a reflective journey that deepened empathy and sparked a practical roadmap for SEL across classrooms.”',
    name: 'Olena Kuzmenko',
    role: 'Director of Pedagogy, Lviv School District',
    icon: '/images/testimonial-rating.svg',
},
  {
    quote:
      '“The trauma-informed framework she shared allowed our staff to create calmer spaces for students while staying grounded under pressure.”',
    name: 'Marco Gutierrez',
    role: 'Wellbeing Coordinator, Future Learning Academy',
    icon: '/images/testimonial-rating.svg',
  },
  {
    quote:
      '“Her approach to digital pedagogy is simultaneously human and innovative—our team now designs online spaces that feel warm, clear, and purposeful.”',
    name: 'Sophie Patel',
    role: 'Digital Learning Lead, Kindred Education',
    icon: '/images/testimonial-rating.svg',
  },
];
const copies = [0, 1, 2];
const slides = copies.flatMap((copy) =>
  testimonials.map((t, i) => ({
    ...t,
    realIndex: i,
    copy,
  }))
);
---

<section class="testimonials-slider" aria-label="Testimonials">
  <div class="container">
    <div class="section-heading">
      <h2>What People Say About My Services</h2>
    </div>

    <div class="slider-window" id="testimonialWindow" role="region" aria-label="Testimonials carousel">
      <div class="slider-track" id="testimonialTrack">
        {slides.map((testimonial) => (
          <article
            class="testimonial-card"
            data-real-index={testimonial.realIndex}
            data-copy={testimonial.copy}
          >
            <div class="emoji">
              <img src={testimonial.icon} alt="testimonial icon" />
            </div>
            <p class="quote">{testimonial.quote}</p>
            <div class="testimonial-footer">
              <p class="author">{testimonial.name}</p>
              <p class="role">{testimonial.role}</p>
            </div>
          </article>
        ))}
      </div>
    </div>

    <div class="slider-controls">
      <button class="control-btn" id="testimonialPrev" aria-label="Previous testimonial">←</button>
      <button class="control-btn" id="testimonialNext" aria-label="Next testimonial">→</button>
    </div>
  </div>

  <script type="module">
    const windowEl = document.getElementById('testimonialWindow');
    const track = document.getElementById('testimonialTrack');
    const prev = document.getElementById('testimonialPrev');
    const next = document.getElementById('testimonialNext');
    
    let activeEl = null;
    let scrollTimeout;
    let isJumping = false;

    const cards = Array.from(track?.querySelectorAll('.testimonial-card') ?? []);

    function setActiveEl(el) {
      if (!(el instanceof Element)) return;
      if (activeEl && activeEl !== el) activeEl.classList.remove('is-active');
      el.classList.add('is-active');
      activeEl = el;
    }

    function getCopyWidth() {
      const a = track?.querySelector('.testimonial-card[data-copy="0"][data-real-index="0"]');
      const b = track?.querySelector('.testimonial-card[data-copy="1"][data-real-index="0"]');
      if (!(a instanceof HTMLElement) || !(b instanceof HTMLElement)) return 0;
      return b.offsetLeft - a.offsetLeft;
    }

    // SILENT REBALANCE: Jumps between copies without animation
    function rebalance() {
      if (!windowEl || isJumping) return;
      const copyWidth = getCopyWidth();
      if (!copyWidth) return;

      const scrollLeft = windowEl.scrollLeft;
      
      // If we've moved too far into copy 2 or back into copy 0, jump back to copy 1
      if (scrollLeft >= copyWidth * 1.8) {
        windowEl.style.scrollSnapType = 'none';
        windowEl.scrollLeft -= copyWidth;
        windowEl.style.scrollSnapType = 'x mandatory';
      } else if (scrollLeft <= copyWidth * 0.2) {
        windowEl.style.scrollSnapType = 'none';
        windowEl.scrollLeft += copyWidth;
        windowEl.style.scrollSnapType = 'x mandatory';
      }
    }

    next?.addEventListener('click', () => {
      if (!windowEl || !activeEl) return;
      const idx = cards.indexOf(activeEl);
      const target = cards[idx + 1];
      
      if (target) {
        windowEl.scrollTo({
          left: target.offsetLeft,
          behavior: 'smooth'
        });
      } else {
        const firstInMiddle = track.querySelector('.testimonial-card[data-copy="1"][data-real-index="0"]');
        if (firstInMiddle instanceof HTMLElement) {
          windowEl.scrollTo({
            left: firstInMiddle.offsetLeft,
            behavior: 'smooth'
          });
        }
      }
    });

    prev?.addEventListener('click', () => {
      if (!windowEl || !activeEl) return;
      const idx = cards.indexOf(activeEl);
      const target = cards[idx - 1];
      
      if (target) {
        windowEl.scrollTo({
          left: target.offsetLeft,
          behavior: 'smooth'
        });
      } else {
        const lastInMiddle = track.querySelector(`.testimonial-card[data-copy="1"][data-real-index="${new Set(cards.map(c => c.dataset.realIndex)).size - 1}"]`);
        if (lastInMiddle instanceof HTMLElement) {
          windowEl.scrollTo({
            left: lastInMiddle.offsetLeft,
            behavior: 'smooth'
          });
        }
      }
    });

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
          // Highlight logic is now handled by the scroll proximity
        }
      });
    }, { root: windowEl, threshold: 0.5 });

    cards.forEach(card => observer.observe(card));

    // CUSTOM ACTIVE HIGHLIGHT BASED ON CENTER
    function updateActiveByCenter() {
      if (!windowEl) return;
      const windowCenter = windowEl.scrollLeft + (windowEl.offsetWidth / 2);
      
      let closestCard = null;
      let minDistance = Infinity;

      cards.forEach(card => {
        const cardCenter = card.offsetLeft + (card.offsetWidth / 2);
        const distance = Math.abs(windowCenter - cardCenter);
        if (distance < minDistance) {
          minDistance = distance;
          closestCard = card;
        }
      });

      if (closestCard) setActiveEl(closestCard);
    }

    // Initial position: Start in copy 1 (middle)
    const startCard = track?.querySelector('.testimonial-card[data-copy="1"][data-real-index="0"]');
    if (startCard instanceof HTMLElement) {
      windowEl.scrollLeft = startCard.offsetLeft;
      setActiveEl(startCard);
    }

    // Check for rebalance after scroll stops
    windowEl?.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      updateActiveByCenter();
      scrollTimeout = setTimeout(rebalance, 100);
    }, { passive: true });

    // --- AUTO SCROLL ---
    let autoScrollInterval;
    const startAutoScroll = () => {
      stopAutoScroll();
      autoScrollInterval = setInterval(() => {
        next?.click();
      }, 5000); // Scroll every 5 seconds
    };

    const stopAutoScroll = () => {
      if (autoScrollInterval) clearInterval(autoScrollInterval);
    };

    // Pause on hover
    windowEl?.addEventListener('mouseenter', stopAutoScroll);
    windowEl?.addEventListener('mouseleave', startAutoScroll);
    
    // Initial start
    startAutoScroll();
  </script>
</section>

<style>
  .testimonials-slider {
    padding: 70px 0;
    background: var(--color-bg-soft);
  }

  .section-heading {
    text-align: left;
    margin-bottom: 40px;
  }

  .section-heading h2 {
    font-family: var(--font-primary);
    font-weight: 700;
    font-size: 46px;
    line-height: 1.14;
    color: var(--color-text-black);
  }

  .section-heading .eyebrow {
    letter-spacing: 0.4em;
    text-transform: uppercase;
    font-size: 12px;
    color: var(--color-text-muted);
    margin-bottom: 12px;
  }

  .slider-window {
    overflow-x: auto;
    overflow-y: visible;
    position: relative;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Firefox */
    width: 100%;
  }

  .slider-window::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
  }

  .slider-track {
    display: flex;
    gap: 24px;
    padding: 10px 0 40px;
  }

  .testimonial-card {
    flex: 0 0 calc((100% - 48px) / 3); /* Exactly 3 cards with 2 gaps of 24px */
    border-radius: 32px;
    padding: 40px;
    min-height: 320px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    opacity: 1;
    transform: none;
    border: 1px solid rgba(141, 119, 171, 0.12);
    background: white;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
    scroll-snap-align: start;
    transition: none;
  }

  /* No special highlight for active card as requested */
  .testimonial-card.is-active {
    border-color: rgba(141, 119, 171, 0.12);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
  }

  .emoji {
    font-size: 32px;
  }

  .emoji img {
    width: 56px;
    height: auto;
    display: block;
  }

  .quote {
    font-size: 20px;
    line-height: 1.6;
    color: var(--color-text-black);
  }

  .author {
    font-weight: 700;
    font-size: 18px;
    color: var(--color-text-black);
  }

  .role {
    font-size: 14px;
    color: var(--color-text-muted);
    margin-top: 2px;
  }

  .testimonial-footer {
    margin-top: auto;
    padding-top: 20px;
    border-top: 1px solid rgba(0,0,0,0.05);
  }

  .slider-controls {
    margin-top: 32px;
    display: flex;
    justify-content: center;
    gap: 16px;
  }

  .control-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 1px solid var(--color-primary);
    background: transparent;
    font-size: 20px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .control-btn:hover {
    background: var(--color-primary);
    color: var(--color-white);
  }

  @media (max-width: 1100px) {
    .testimonial-card {
      flex: 0 0 calc((100% - 24px) / 2); /* 2 cards */
      padding: 32px;
    }
  }

  @media (max-width: 768px) {
    .testimonials-slider {
      padding: 50px 0;
    }

    .slider-track {
      gap: 16px;
      padding: 10px 0 40px;
    }

    .testimonial-card {
      flex: 0 0 100%; /* 1 card */
      padding: 28px;
      min-height: 240px;
    }

    .section-heading h2 {
      font-size: 28px;
      text-align: center;
    }

    .slider-controls {
      margin-top: 20px;
    }
  }
</style>

