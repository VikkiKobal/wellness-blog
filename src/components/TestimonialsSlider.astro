---
const testimonials = [
  {
    quote:
      '“Antonina guided our leadership team through a reflective journey that deepened empathy and sparked a practical roadmap for SEL across classrooms.”',
    name: 'Olena Kuzmenko',
    role: 'Director of Pedagogy, Lviv School District',
    icon: '/images/testimonial-rating.svg',
},
  {
    quote:
      '“The trauma-informed framework she shared allowed our staff to create calmer spaces for students while staying grounded under pressure.”',
    name: 'Marco Gutierrez',
    role: 'Wellbeing Coordinator, Future Learning Academy',
    icon: '/images/testimonial-rating.svg',
  },
  {
    quote:
      '“Her approach to digital pedagogy is simultaneously human and innovative—our team now designs online spaces that feel warm, clear, and purposeful.”',
    name: 'Sophie Patel',
    role: 'Digital Learning Lead, Kindred Education',
    icon: '/images/testimonial-rating.svg',
  },
];
const copies = [0, 1, 2];
const slides = copies.flatMap((copy) =>
  testimonials.map((t, i) => ({
    ...t,
    realIndex: i,
    copy,
  }))
);
---

<section class="testimonials-slider" aria-label="Testimonials">
  <div class="container">
    <div class="section-heading">
      <h2>What People Say About My Services</h2>
    </div>

    <div class="slider-window" id="testimonialWindow" role="region" aria-label="Testimonials carousel">
      <div class="slider-track" id="testimonialTrack">
        {slides.map((testimonial) => (
          <article
            class="testimonial-card"
            data-real-index={testimonial.realIndex}
            data-copy={testimonial.copy}
          >
            <div class="emoji">
              <img src={testimonial.icon} alt="testimonial icon" />
            </div>
            <p class="quote">{testimonial.quote}</p>
            <p class="author">{testimonial.name}</p>
            <p class="role">{testimonial.role}</p>
          </article>
        ))}
      </div>
    </div>

    <div class="slider-controls">
      <button class="control-btn" id="testimonialPrev" aria-label="Previous testimonial">←</button>
      <button class="control-btn" id="testimonialNext" aria-label="Next testimonial">→</button>
    </div>
  </div>

  <script type="module">
    const windowEl = document.getElementById('testimonialWindow');
    const track = document.getElementById('testimonialTrack');
    const testimonials = track?.querySelectorAll('.testimonial-card') ?? [];
    const realSlides = track?.querySelectorAll('.testimonial-card[data-is-clone="false"]') ?? [];
    const prev = document.getElementById('testimonialPrev');
    const next = document.getElementById('testimonialNext');
    // real index (0..n-1)
    let currentIndex = 0;
    let isJumping = false;
    let scrollEndTimer;
    let activeEl = null;

    // helpers
    const cards = Array.from(testimonials);
    const realTotal = Math.max(0, new Set(cards.map((c) => c.getAttribute('data-real-index'))).size);

    function setActiveEl(el) {
      if (!(el instanceof Element)) return;
      const real = Number(el.getAttribute('data-real-index') ?? '0');
      currentIndex = real;

      if (activeEl && activeEl !== el) activeEl.classList.remove('is-active');
      el.classList.add('is-active');
      activeEl = el;
    }

    function getCopyWidth() {
      // distance between the start of copy 0 and copy 1
      const a = track?.querySelector('.testimonial-card[data-copy="0"][data-real-index="0"]');
      const b = track?.querySelector('.testimonial-card[data-copy="1"][data-real-index="0"]');
      if (!(a instanceof HTMLElement) || !(b instanceof HTMLElement)) return 0;
      return b.offsetLeft - a.offsetLeft;
    }

    prev?.addEventListener('click', () => {
      if (!activeEl) return;
      const idx = cards.indexOf(activeEl);
      const target = cards[idx - 1] ?? cards[cards.length - 1];
      target?.scrollIntoView({ behavior: 'smooth', inline: 'start', block: 'nearest' });
    });

    next?.addEventListener('click', () => {
      if (!activeEl) return;
      const idx = cards.indexOf(activeEl);
      const target = cards[idx + 1] ?? cards[0];
      target?.scrollIntoView({ behavior: 'smooth', inline: 'start', block: 'nearest' });
    });

    // Update active card based on what is most visible in the window.
    const observer =
      windowEl && testimonials.length
        ? new IntersectionObserver(
            (entries) => {
              if (isJumping) return;
              let bestEl = activeEl;
              let bestRatio = 0;
              for (const entry of entries) {
                const el = entry.target;
                if (!(el instanceof HTMLElement)) continue;
                if (entry.intersectionRatio > bestRatio) {
                  bestRatio = entry.intersectionRatio;
                  bestEl = el;
                }
              }
              if (bestEl) setActiveEl(bestEl);
            },
            { root: windowEl, threshold: [0.5, 0.65, 0.8] }
          )
        : null;

    observer?.disconnect();
    testimonials.forEach((card) => observer?.observe(card));

    // Init: start in the middle copy so the loop never "hits an end".
    const start = track?.querySelector('.testimonial-card[data-copy="1"][data-real-index="0"]');
    if (start instanceof HTMLElement && windowEl) {
      windowEl.scrollLeft = start.offsetLeft - 40; // 40 is the track padding-left
      setActiveEl(start);
    } else if (cards[0]) {
      setActiveEl(cards[0]);
    }

    function rebalanceInfiniteScroll() {
      if (!windowEl || !track || !realTotal) return;
      const copyWidth = getCopyWidth();
      if (!copyWidth) return;

      // Keep scrollLeft within the middle copy.
      const leftBound = copyWidth * 0.5;
      const rightBound = copyWidth * 1.5;

      if (windowEl.scrollLeft < leftBound) {
        isJumping = true;
        windowEl.classList.add('is-rebalancing');
        windowEl.scrollLeft += copyWidth;
        requestAnimationFrame(() => {
          windowEl.classList.remove('is-rebalancing');
          isJumping = false;
        });
      } else if (windowEl.scrollLeft > rightBound) {
        isJumping = true;
        windowEl.classList.add('is-rebalancing');
        windowEl.scrollLeft -= copyWidth;
        requestAnimationFrame(() => {
          windowEl.classList.remove('is-rebalancing');
          isJumping = false;
        });
      }
    }

    windowEl?.addEventListener(
      'scroll',
      () => {
        clearTimeout(scrollEndTimer);
        scrollEndTimer = setTimeout(rebalanceInfiniteScroll, 50);
      },
      { passive: true }
    );
  </script>
</section>

<style>
  .testimonials-slider {
    padding: 70px 0;
    background: var(--color-bg-soft);
  }

  .section-heading {
    text-align: left;
    margin-bottom: 40px;
  }

  .section-heading h2 {
    font-family: var(--font-primary);
    font-weight: 700;
    font-size: 46px;
    line-height: 1.14;
    color: var(--color-text-black);
  }

  .section-heading .eyebrow {
    letter-spacing: 0.4em;
    text-transform: uppercase;
    font-size: 12px;
    color: var(--color-text-muted);
    margin-bottom: 12px;
  }

  .slider-window {
    overflow-x: auto;
    overflow-y: visible;
    position: relative;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Firefox */
  }

  .slider-window.is-rebalancing {
    scroll-snap-type: none;
  }

  .slider-window::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
  }

  .slider-track {
    display: flex;
    gap: 24px;
    padding: 4px 40px 10px;
  }

  .testimonial-card {
    flex: 0 0 460px;
    border-radius: 32px;
    padding: 40px;
    min-height: 260px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    opacity: 0.6;
    transform: scale(0.95);
    transition: transform 0.3s ease, opacity 0.3s ease;
    border: 1px solid rgba(17, 82, 62, 0.12);
    background: rgba(255, 255, 255, 0.85);
    box-shadow: none;
    scroll-snap-align: start;
  }

  .testimonial-card.is-active {
    opacity: 1;
    transform: scale(1);
  }

  .emoji {
    font-size: 32px;
  }

  .emoji img {
    width: 56px;
    height: auto;
    display: block;
  }

  .quote {
    font-size: 20px;
    line-height: 1.6;
    color: var(--color-text-black);
  }

  .author {
    font-weight: 600;
    font-size: 18px;
    margin-top: auto;
  }

  .role {
    font-size: 16px;
    color: var(--color-text-muted);
  }

  .slider-controls {
    margin-top: 32px;
    display: flex;
    justify-content: center;
    gap: 16px;
  }

  .control-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 1px solid var(--color-primary);
    background: transparent;
    font-size: 20px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .control-btn:hover {
    background: var(--color-primary);
    color: var(--color-white);
  }

  @media (max-width: 1100px) {
    .testimonial-card {
      flex: 0 0 380px;
      padding: 32px;
    }
  }

  @media (max-width: 1270px) {
    .section-heading h2 {
      font-size: 36px;
    }
  }

  @media (max-width: 968px) {
    .section-heading h2 {
      font-size: 36px;
    }
  }

  @media (max-width: 768px) {
    .testimonials-slider {
      padding: 50px 0;
    }

    .slider-track {
      gap: 16px;
      padding: 4px 20px 10px;
    }

    .testimonial-card {
      flex: 0 0 calc(100% - 40px);
      padding: 28px;
      min-height: 240px;
    }

    .section-heading h2 {
      font-size: 28px;
      text-align: center;
    }

    .slider-controls {
      margin-top: 20px;
    }
  }
</style>

