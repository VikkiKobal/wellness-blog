---
const testimonials = [
  {
    quote:
      '“Antonina guided our leadership team through a reflective journey that deepened empathy and sparked a practical roadmap for SEL across classrooms.”',
    name: 'Olena Kuzmenko',
    role: 'Director of Pedagogy, Lviv School District',
    icon: '/images/testimonial-rating.svg',
},
  {
    quote:
      '“The trauma-informed framework she shared allowed our staff to create calmer spaces for students while staying grounded under pressure.”',
    name: 'Marco Gutierrez',
    role: 'Wellbeing Coordinator, Future Learning Academy',
    icon: '/images/testimonial-rating.svg',
  },
  {
    quote:
      '“Her approach to digital pedagogy is simultaneously human and innovative—our team now designs online spaces that feel warm, clear, and purposeful.”',
    name: 'Sophie Patel',
    role: 'Digital Learning Lead, Kindred Education',
    icon: '/images/testimonial-rating.svg',
  },
];

const slides = [
  { ...testimonials[testimonials.length - 1], realIndex: testimonials.length - 1, isClone: true, clonePos: 'start' as const },
  ...testimonials.map((t, i) => ({ ...t, realIndex: i, isClone: false, clonePos: undefined })),
  { ...testimonials[0], realIndex: 0, isClone: true, clonePos: 'end' as const },
];
---

<section class="testimonials-slider" aria-label="Testimonials">
  <div class="container">
    <div class="section-heading">
      <h2>What People Say About My Services</h2>
    </div>

    <div class="slider-window" id="testimonialWindow" role="region" aria-label="Testimonials carousel">
      <div class="slider-track" id="testimonialTrack">
        {slides.map((testimonial) => (
          <article
            class:list={['testimonial-card', { 'is-clone': testimonial.isClone }]}
            data-real-index={testimonial.realIndex}
            data-is-clone={testimonial.isClone ? 'true' : 'false'}
            data-clone-pos={testimonial.clonePos}
          >
            <div class="emoji">
              <img src={testimonial.icon} alt="testimonial icon" />
            </div>
            <p class="quote">{testimonial.quote}</p>
            <p class="author">{testimonial.name}</p>
            <p class="role">{testimonial.role}</p>
          </article>
        ))}
      </div>
    </div>

    <div class="slider-controls">
      <button class="control-btn" id="testimonialPrev" aria-label="Previous testimonial">←</button>
      <button class="control-btn" id="testimonialNext" aria-label="Next testimonial">→</button>
    </div>
  </div>

  <script type="module">
    const windowEl = document.getElementById('testimonialWindow');
    const track = document.getElementById('testimonialTrack');
    const testimonials = track?.querySelectorAll('.testimonial-card') ?? [];
    const prev = document.getElementById('testimonialPrev');
    const next = document.getElementById('testimonialNext');
    // real index (0..n-1)
    let currentIndex = 0;
    let isJumping = false;
    let scrollEndTimer;

    function setActive(index) {
      currentIndex = Math.max(0, Math.min(index, testimonials.length - 1));
      // Mark active among *real* slides
      testimonials.forEach((card) => {
        const real = Number(card.getAttribute('data-real-index') ?? '0');
        const isClone = card.getAttribute('data-is-clone') === 'true';
        card.classList.toggle('is-active', !isClone && real === currentIndex);
      });
    }

    function getRealSlideEl(realIndex) {
      // choose the non-clone slide
      return track?.querySelector(`.testimonial-card[data-real-index="${realIndex}"][data-is-clone="false"]`);
    }

    function scrollToRealIndex(index, behavior = 'smooth') {
      const card = getRealSlideEl(index);
      if (!card) return;
      card.scrollIntoView({ behavior, inline: 'start', block: 'nearest' });
      setActive(index);
    }

    prev?.addEventListener('click', () => {
      const total = Number(windowEl?.getAttribute('data-real-total') ?? '0');
      if (!total) return;
      scrollToRealIndex((currentIndex - 1 + total) % total);
    });

    next?.addEventListener('click', () => {
      const total = Number(windowEl?.getAttribute('data-real-total') ?? '0');
      if (!total) return;
      scrollToRealIndex((currentIndex + 1) % total);
    });

    // Update active card based on what is most visible in the window.
    const observer =
      windowEl && testimonials.length
        ? new IntersectionObserver(
            (entries) => {
              if (isJumping) return;
              let best = { index: currentIndex, ratio: 0 };
              for (const entry of entries) {
                const el = entry.target;
                if (!(el instanceof HTMLElement)) continue;
                const idx = Number(el.getAttribute('data-real-index') ?? '0');
                if (entry.intersectionRatio > best.ratio) {
                  best = { index: idx, ratio: entry.intersectionRatio };
                }
              }
              setActive(best.index);
            },
            { root: windowEl, threshold: [0.5, 0.65, 0.8] }
          )
        : null;

    observer?.disconnect();
    testimonials.forEach((card) => observer?.observe(card));

    // Init
    // expose total to handlers without importing
    windowEl?.setAttribute('data-real-total', String(Math.max(0, (testimonials.length - 2))));

    // Start on the first *real* slide (skip the leading clone)
    const firstReal = getRealSlideEl(0);
    if (firstReal) {
      firstReal.scrollIntoView({ behavior: 'auto', inline: 'start', block: 'nearest' });
    }
    setActive(0);

    // Loop behavior for swipe: when user snaps to a clone, jump to the corresponding real slide.
    function handleLoopJump() {
      if (!windowEl || !track) return;

      // Find the slide closest to the left edge of the window
      const windowRect = windowEl.getBoundingClientRect();
      let bestEl = null;
      let bestDist = Infinity;
      for (const card of testimonials) {
        const rect = card.getBoundingClientRect();
        const dist = Math.abs(rect.left - windowRect.left);
        if (dist < bestDist) {
          bestDist = dist;
          bestEl = card;
        }
      }
      if (!(bestEl instanceof Element)) return;

      const isClone = bestEl.getAttribute('data-is-clone') === 'true';
      if (!isClone) return;

      const real = Number(bestEl.getAttribute('data-real-index') ?? '0');
      isJumping = true;
      scrollToRealIndex(real, 'auto');
      // allow observer again next tick
      requestAnimationFrame(() => {
        isJumping = false;
      });
    }

    windowEl?.addEventListener(
      'scroll',
      () => {
        clearTimeout(scrollEndTimer);
        scrollEndTimer = setTimeout(handleLoopJump, 80);
      },
      { passive: true }
    );
  </script>
</section>

<style>
  .testimonials-slider {
    padding: 100px 0;
    background: var(--color-bg-soft);
  }

  .section-heading {
    text-align: left;
    margin-bottom: 40px;
  }

  .section-heading h2 {
    font-family: var(--font-primary);
    font-weight: 700;
    font-size: 46px;
    line-height: 1.14;
    color: var(--color-text-black);
  }

  .section-heading .eyebrow {
    letter-spacing: 0.4em;
    text-transform: uppercase;
    font-size: 12px;
    color: var(--color-text-muted);
    margin-bottom: 12px;
  }

  .slider-window {
    overflow-x: auto;
    overflow-y: visible;
    position: relative;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Firefox */
  }

  .slider-window::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
  }

  .slider-track {
    display: flex;
    gap: 24px;
    padding: 4px 20px 10px;
  }

  .testimonial-card {
    flex: 0 0 460px;
    border-radius: 32px;
    padding: 40px;
    min-height: 260px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    opacity: 0.6;
    transform: scale(0.95);
    transition: transform 0.3s ease, opacity 0.3s ease;
    border: 1px solid rgba(17, 82, 62, 0.12);
    background: rgba(255, 255, 255, 0.85);
    box-shadow: none;
    scroll-snap-align: start;
  }

  .testimonial-card.is-clone {
    opacity: 0.25;
  }

  .testimonial-card.is-active {
    opacity: 1;
    transform: scale(1);
  }

  .emoji {
    font-size: 32px;
  }

  .emoji img {
    width: 56px;
    height: auto;
    display: block;
  }

  .quote {
    font-size: 20px;
    line-height: 1.6;
    color: var(--color-text-black);
  }

  .author {
    font-weight: 600;
    font-size: 18px;
    margin-top: auto;
  }

  .role {
    font-size: 16px;
    color: var(--color-text-muted);
  }

  .slider-controls {
    margin-top: 32px;
    display: flex;
    justify-content: center;
    gap: 16px;
  }

  .control-btn {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: 1px solid var(--color-primary);
    background: transparent;
    font-size: 20px;
    cursor: pointer;
    transition: background-color 0.3s ease, color 0.3s ease;
  }

  .control-btn:hover {
    background: var(--color-primary);
    color: var(--color-white);
  }

  @media (max-width: 1100px) {
    .testimonial-card {
      flex: 0 0 380px;
      padding: 32px;
    }
  }

  @media (max-width: 968px) {
    .section-heading h2 {
      font-size: 36px;
    }
  }

  @media (max-width: 768px) {
    .testimonials-slider {
      padding: 60px 0;
    }

    .slider-track {
      gap: 16px;
      padding: 4px 16px 10px;
    }

    .testimonial-card {
      flex: 0 0 calc(100% - 32px);
      padding: 24px;
    }

    .section-heading h2 {
      font-size: 28px;
      text-align: center;
    }

    .slider-controls {
      margin-top: 20px;
    }
  }
</style>

